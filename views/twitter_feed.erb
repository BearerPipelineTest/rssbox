<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>twitter:<%= @user_id %></id>
  <title><%= @username %> on Twitter</title>
  <icon>https://abs.twimg.com/favicons/favicon.ico</icon>
  <link href="<%= request.original_url.esc %>" rel="self" />
  <link href="https://twitter.com/<%= @username %>" rel="alternate" />
  <updated><%= Time.parse(@data[0]["created_at"]) if @data[0] %></updated>
<%-
@data.each do |tweet|
  if tweet["retweeted_status"]
    text = "RT #{tweet["retweeted_status"]["user"]["screen_name"]}: #{tweet["retweeted_status"]["text"]}"
    entities = tweet["retweeted_status"]["entities"]["urls"]
  else
    text = tweet["text"]
    entities = tweet["entities"]["urls"]
  end
  for entity in entities
    text.gsub!(entity["url"], entity["expanded_url"])
  end
  body = text.dup
  title = text.dup
  URI.extract(-text, %w[http https]) do |url|
    dest = url.resolve_url
    title.gsub!(url, "[#{dest.short_host}]")
    body.gsub!(url, "<a href='#{dest}' title='#{url}' rel='noreferrer'>#{dest}</a>")
  end
-%>

  <entry>
    <id>twitter:tweet:<%= tweet["id_str"] %><%= ":#{params[:cachebuster]}" if params[:cachebuster] %></id>
    <title><%= title.to_line.esc %></title>
    <link href="https://twitter.com/<%= @username %>/status/<%= tweet["id_str"] %>" />
    <updated><%= Time.parse(tweet["created_at"]) %></updated>
    <author><name><%= @username %></name></author>
    <content type="html">
<%= body.esc %>
    </content>
  </entry>
<%- end -%>
</feed>
